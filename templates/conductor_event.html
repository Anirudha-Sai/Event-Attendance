<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Event - {{ event.title }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      background: #f4f6f8;
      font-family: 'Inter', 'Segoe UI', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .event-container {
      background: #fff;
      width: 100%;
      max-width: 900px;
      margin: 40px 10px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 30px;
    }
    .event-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .event-header h3 {
      margin: 0;
      font-weight: 600;
      color: #2c3e50;
    }
    .event-details {
      color: #555;
      font-size: 0.95rem;
      margin-bottom: 20px;
    }
    .btn-custom {
      border-radius: 10px;
      font-weight: 500;
      transition: all 0.2s;
    }
    .btn-custom:hover {
      transform: translateY(-1px);
    }
    #scanner {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
    }
    table {
      margin-top: 20px;
    }
    th {
      background: #f1f3f4;
      font-weight: 600;
    }
    td {
      vertical-align: middle;
    }
    @media (max-width: 576px) {
      .event-container {
        margin: 20px 10px;
        padding: 20px;
      }
      .event-header {
        flex-direction: column;
        align-items: flex-start;
      }
      #reader {
        width: 100% !important;
      }
    }
  </style>
</head>
<body>

  <div class="event-container">
    <div class="event-header">
      <h3>{{ event.title }}</h3>
      <a class="btn btn-outline-secondary btn-custom" href="{{ url_for('dashboard') }}">Back</a>
    </div>

    <p class="event-details">{{ event.description }} • {{ event.location }} • {{ event.when_dt }}</p>

    <div class="mb-3">
      <button id="startScan" class="btn btn-success btn-custom">Add Attendance (Scan)</button>
    </div>

    <div id="scanner" style="display:none;">
      <div id="reader" style="width:100%;max-width:480px;margin:auto;"></div>
      <div class="mt-3 text-center">
        <button id="stopScan" class="btn btn-sm btn-danger btn-custom">Stop Scanner</button>
      </div>
    </div>

    <h5 class="mt-4 text-secondary">Scanned / Pending (latest first)</h5>
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Roll</th>
            <th>Name</th>
            <th>Branch</th>
            <th>Scanned At (UTC)</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="attendanceTable">
          {% for r in rows %}
            <tr>
              <td>{{ r.roll }}</td>
              <td>{{ r.student_name or "Unknown" }}</td>
              <td>{{ r.branch or "-" }}</td>
              <td>{{ r.scanned_at }}</td>
              <td>{{ r.status }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <script>
  const eventId = "{{ event.id }}";
  let html5QrCode = null;

  document.getElementById("startScan").addEventListener("click", () => {
    document.getElementById("scanner").style.display = "block";
    const readerElem = document.getElementById("reader");
    readerElem.innerHTML = "";
    html5QrCode = new Html5Qrcode("reader");

    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText) => {
        html5QrCode.stop().then(() => {
          fetch("/scan_lookup", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ roll: decodedText })
          }).then(res => res.json()).then(data => {
            const name = data.name || "Unknown";
            const branch = data.branch || "Unknown";
            if (confirm(`Scanned: ${decodedText}\nName: ${name}\nBranch: ${branch}\n\nAdd to attendance?`)) {
              fetch("/add_scan", {
                method: "POST",
                headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ event_id: eventId, roll: decodedText })
              }).then(res => res.json()).then(js => {
                const tb = document.getElementById("attendanceTable");
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${decodedText}</td><td>${name}</td><td>${branch}</td><td>${js.scanned_at}</td><td>Pending</td>`;
                tb.prepend(tr);
              });
            }
          });
        }).catch(err => console.error(err));
      },
      (err) => {}
    ).catch(err => {
      alert("Camera permission or device error: " + err);
    });
  });

  document.getElementById("stopScan").addEventListener("click", () => {
    if (html5QrCode) {
      html5QrCode.stop().then(() => {
        document.getElementById("scanner").style.display = "none";
      });
    } else {
      document.getElementById("scanner").style.display = "none";
    }
  });
  </script>

</body>
</html>
